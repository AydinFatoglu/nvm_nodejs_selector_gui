import os
import sys
import tkinter as tk
from tkinter import ttk, messagebox
import threading
import winreg
import ctypes


class NVMGui:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("NVM Node.js Selector")
        self.root.resizable(False, False)
        
        # Pencere boyutu
        window_width = 420
        window_height = 380
        
        # Ekran ortasÄ±na konumlandÄ±r
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2
        self.root.geometry(f"{window_width}x{window_height}+{x}+{y}")
        
        # NVM Home
        self.nvm_home = os.getenv("NVM_HOME", "")
        
        self.setup_ui()
        self.load_versions()
    
    def setup_ui(self):
        """UI bileÅŸenlerini oluÅŸtur"""
        main_frame = ttk.Frame(self.root, padding=20)
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # BaÅŸlÄ±k
        title_label = ttk.Label(
            main_frame, 
            text="ğŸŸ¢ Node.js Version Selector", 
            font=("Segoe UI", 14, "bold")
        )
        title_label.pack(pady=(0, 5))
        
        # Alt baÅŸlÄ±k
        subtitle_label = ttk.Label(
            main_frame,
            text="Kurulu versiyona Ã§ift tÄ±klayarak aktif edin. Versiyon kurulumu iÃ§in cmd Ã¼zerinden (nvm install) kullanÄ±n.",
            font=("Segoe UI", 9),
            foreground="black",
            wraplength=400,        # â† metni 400 pxâ€™de kaydÄ±r
            justify="left"         # â† satÄ±r hizasÄ± (left / center)
        )
        subtitle_label.pack(pady=(0, 15))
        
        # Mevcut versiyon
        current_frame = ttk.LabelFrame(main_frame, text="Aktif SÃ¼rÃ¼m", padding=10)
        current_frame.pack(fill=tk.X, pady=(0, 15))
        
        self.current_version_var = tk.StringVar(value="YÃ¼kleniyor...")
        self.current_version_label = ttk.Label(
            current_frame, 
            textvariable=self.current_version_var, 
            font=("Segoe UI", 11, "bold"),
            foreground="#2e7d32"
        )
        self.current_version_label.pack()
        
        # Versiyon listesi
        list_frame = ttk.LabelFrame(main_frame, text="Kurulu SÃ¼rÃ¼mler", padding=10)
        list_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 15))
        
        # Listbox ve scrollbar
        list_container = ttk.Frame(list_frame)
        list_container.pack(fill=tk.BOTH, expand=True)
        
        scrollbar = ttk.Scrollbar(list_container)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        self.version_listbox = tk.Listbox(
            list_container,
            font=("Consolas", 12),
            selectmode=tk.SINGLE,
            yscrollcommand=scrollbar.set,
            activestyle='dotbox',
            selectbackground='#1976d2',
            selectforeground='white'
        )
        self.version_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.config(command=self.version_listbox.yview)
        
        # Ã‡ift tÄ±klama ile seÃ§im
        self.version_listbox.bind('<Double-Button-1>', lambda e: self.use_selected_version())
        
        # Butonlar
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill=tk.X)
        
        self.use_button = ttk.Button(
            button_frame,
            text="âš¡ Set / Use",
            command=self.use_selected_version
        )
        self.use_button.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=(0, 5))
        
        refresh_button = ttk.Button(
            button_frame,
            text="â†» Yenile",
            command=self.load_versions
        )
        refresh_button.pack(side=tk.RIGHT)
        
        # Status bar
        self.status_var = tk.StringVar(value="HazÄ±r")
        status_bar = ttk.Label(
            main_frame, 
            textvariable=self.status_var, 
            font=("Segoe UI", 9),
            foreground="gray"
        )
        status_bar.pack(pady=(10, 0))
    
    def get_user_path(self):
        """User PATH deÄŸerini oku"""
        try:
            key = winreg.OpenKey(
                winreg.HKEY_CURRENT_USER,
                r"Environment",
                0,
                winreg.KEY_READ
            )
            value, _ = winreg.QueryValueEx(key, "Path")
            winreg.CloseKey(key)
            return value
        except:
            return ""
    
    def set_user_path(self, new_path):
        """User PATH deÄŸerini ayarla"""
        try:
            key = winreg.OpenKey(
                winreg.HKEY_CURRENT_USER,
                r"Environment",
                0,
                winreg.KEY_ALL_ACCESS
            )
            winreg.SetValueEx(key, "Path", 0, winreg.REG_EXPAND_SZ, new_path)
            winreg.CloseKey(key)
            
            # DeÄŸiÅŸikliÄŸi broadcast et
            self.broadcast_environment_change()
            return True
        except Exception as e:
            print(f"PATH ayarlama hatasÄ±: {e}")
            return False
    
    def broadcast_environment_change(self):
        """Ortam deÄŸiÅŸkeni deÄŸiÅŸikliÄŸini sisteme bildir"""
        try:
            HWND_BROADCAST = 0xFFFF
            WM_SETTINGCHANGE = 0x1A
            SMTO_ABORTIFHUNG = 0x0002
            
            result = ctypes.c_long()
            ctypes.windll.user32.SendMessageTimeoutW(
                HWND_BROADCAST,
                WM_SETTINGCHANGE,
                0,
                "Environment",
                SMTO_ABORTIFHUNG,
                5000,
                ctypes.byref(result)
            )
        except:
            pass
    
    def get_node_versions(self):
        """Kurulu Node versiyonlarÄ±nÄ± bul"""
        versions = []
        
        if not self.nvm_home or not os.path.exists(self.nvm_home):
            return versions
        
        for item in os.listdir(self.nvm_home):
            item_path = os.path.join(self.nvm_home, item)
            if os.path.isdir(item_path):
                # node.exe var mÄ± kontrol et
                if os.path.exists(os.path.join(item_path, "node.exe")):
                    versions.append(item)
        
        # SÄ±rala (en yeni Ã¼stte)
        try:
            versions.sort(
                key=lambda v: [int(x) for x in v.lstrip('v').split('.')[:3] if x.isdigit()], 
                reverse=True
            )
        except:
            versions.sort(reverse=True)
        
        return versions
    
    def get_active_version(self):
        """PATH'teki aktif Node versiyonunu bul"""
        user_path = self.get_user_path()
        
        if not self.nvm_home:
            return None
        
        # PATH'te NVM klasÃ¶rlerinden hangisi var?
        path_parts = user_path.split(';')
        
        for part in path_parts:
            part = part.strip()
            if self.nvm_home.lower() in part.lower():
                # Bu bir NVM Node klasÃ¶rÃ¼ mÃ¼?
                if os.path.exists(os.path.join(part, "node.exe")):
                    # Versiyon adÄ±nÄ± Ã§Ä±kar
                    return os.path.basename(part)
        
        return None
    
    def load_versions(self):
        """Kurulu versiyonlarÄ± yÃ¼kle"""
        self.status_var.set("SÃ¼rÃ¼mler yÃ¼kleniyor...")
        self.version_listbox.delete(0, tk.END)
        self.root.update()
        
        def load():
            versions = self.get_node_versions()
            current_version = self.get_active_version()
            
            # UI gÃ¼ncelle (ana thread'de)
            self.root.after(0, lambda: self.update_ui(versions, current_version))
        
        thread = threading.Thread(target=load, daemon=True)
        thread.start()
    
    def update_ui(self, versions, current_version):
        """UI'Ä± gÃ¼ncelle"""
        self.version_listbox.delete(0, tk.END)
        
        if versions:
            for i, v in enumerate(versions):
                is_active = (v == current_version)
                if is_active:
                    display = f"â–º {v} (aktif)"
                else:
                    display = f"   {v}"
                self.version_listbox.insert(tk.END, display)
                
                # Aktif olanÄ± yeÅŸil yap
                if is_active:
                    self.version_listbox.itemconfig(i, fg='#2e7d32', selectforeground='white')
            
            if current_version:
                self.current_version_var.set(f"Node.js {current_version}")
            else:
                self.current_version_var.set("Listeden Node versiyonu seÅŸiniz...")
            
            self.status_var.set(f"{len(versions)} sÃ¼rÃ¼m bulundu")
        else:
            self.version_listbox.insert(tk.END, "  Kurulu sÃ¼rÃ¼m yok")
            self.current_version_var.set("Kurulu deÄŸil")
            self.status_var.set("nvm install <version> ile sÃ¼rÃ¼m kurun")
    
    def use_selected_version(self):
        """SeÃ§ili versiyona geÃ§ (PATH manipulation)"""
        selection = self.version_listbox.curselection()
        if not selection:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir sÃ¼rÃ¼m seÃ§in!")
            return
        
        selected = self.version_listbox.get(selection[0])
        
        # Versiyon numarasÄ±nÄ± Ã§Ä±kar
        version = selected.replace('â–º', '').replace('(aktif)', '').strip()
        
        if not version:
            return
        
        self.status_var.set(f"{version} sÃ¼rÃ¼mÃ¼ne geÃ§iliyor...")
        self.use_button.config(state='disabled')
        self.root.update()
        
        def switch():
            success, message = self.switch_node_version(version)
            self.root.after(0, lambda: self.switch_complete(version, success, message))
        
        thread = threading.Thread(target=switch, daemon=True)
        thread.start()
    
    def switch_node_version(self, version):
        """Node versiyonunu PATH manipulation ile deÄŸiÅŸtir"""
        try:
            if not self.nvm_home:
                return False, "NVM_HOME bulunamadÄ±"
            
            # Yeni versiyon klasÃ¶rÃ¼
            new_node_path = os.path.join(self.nvm_home, version)
            
            if not os.path.exists(new_node_path):
                return False, f"Versiyon klasÃ¶rÃ¼ bulunamadÄ±: {new_node_path}"
            
            if not os.path.exists(os.path.join(new_node_path, "node.exe")):
                return False, f"node.exe bulunamadÄ±: {new_node_path}"
            
            # Mevcut PATH'i al
            user_path = self.get_user_path()
            path_parts = user_path.split(';')
            
            # Eski NVM Node yollarÄ±nÄ± Ã§Ä±kar
            new_path_parts = []
            for part in path_parts:
                part = part.strip()
                if not part:
                    continue
                
                # Bu bir NVM Node klasÃ¶rÃ¼ mÃ¼?
                if self.nvm_home.lower() in part.lower():
                    # node.exe iÃ§eren NVM klasÃ¶rlerini atla
                    check_path = part
                    # %NVM_HOME% gibi deÄŸiÅŸkenleri Ã§Ã¶z
                    check_path = os.path.expandvars(check_path)
                    if os.path.exists(os.path.join(check_path, "node.exe")):
                        continue  # Bu eski Node yolu, atla
                
                new_path_parts.append(part)
            
            # Yeni Node yolunu baÅŸa ekle
            new_path_parts.insert(0, new_node_path)
            
            # PATH'i gÃ¼ncelle
            new_path = ';'.join(new_path_parts)
            
            if self.set_user_path(new_path):
                return True, f"{version} aktif edildi"
            else:
                return False, "PATH gÃ¼ncellenemedi"
                
        except Exception as e:
            return False, str(e)
    
    def switch_complete(self, version, success, message):
        """GeÃ§iÅŸ tamamlandÄ±"""
        self.use_button.config(state='normal')
        
        if success:
            self.status_var.set(f"âœ“ {version} aktif edildi")
            self.current_version_var.set(f"Node.js {version}")
            messagebox.showinfo(
                "BaÅŸarÄ±lÄ±", 
                f"Node.js {version} aktif edildi!\n\n"
                f"âš ï¸ Yeni terminal penceresi aÃ§Ä±n.\n"
                f"Mevcut terminaller eski PATH'i kullanmaya devam eder."
            )
            self.load_versions()
        else:
            self.status_var.set("âœ— GeÃ§iÅŸ baÅŸarÄ±sÄ±z")
            messagebox.showerror("Hata", f"SÃ¼rÃ¼m deÄŸiÅŸtirilemedi:\n\n{message}")
    
    def run(self):
        """UygulamayÄ± baÅŸlat"""
        self.root.mainloop()


def main():
    # NVM kurulu mu kontrol et
    nvm_home = os.getenv("NVM_HOME")
    
    if not nvm_home:
        root = tk.Tk()
        root.withdraw()
        messagebox.showerror(
            "NVM BulunamadÄ±",
            "NVM_HOME ortam deÄŸiÅŸkeni ayarlanmamÄ±ÅŸ.\n\n"
            "LÃ¼tfen Ã¶nce NVM kurulum scriptini Ã§alÄ±ÅŸtÄ±rÄ±n."
        )
        sys.exit(1)
    
    if not os.path.exists(nvm_home):
        root = tk.Tk()
        root.withdraw()
        messagebox.showerror(
            "NVM BulunamadÄ±",
            f"NVM klasÃ¶rÃ¼ bulunamadÄ±:\n{nvm_home}\n\n"
            "LÃ¼tfen Ã¶nce NVM kurulum scriptini Ã§alÄ±ÅŸtÄ±rÄ±n."
        )
        sys.exit(1)
    
    app = NVMGui()
    app.run()


if __name__ == "__main__":
    main()

